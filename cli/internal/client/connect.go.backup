package client

import (
	"fmt"
	"strconv"

	"github.com/spf13/cobra"
	"github.com/instatunnel/cli/pkg/tunnel"
)

var connectCmd = &cobra.Command{
	Use:   "connect [port]",
	Short: "Connect to an existing tunnel created via web dashboard",
	Long: `Connect to an existing tunnel that was created via the web dashboard.
	
You must specify the subdomain of the existing tunnel using the --subdomain flag.

Examples:
  instatunnel connect 3000 --subdomain myapp
  instatunnel connect 8000 -s myproject`,
	Args: cobra.ExactArgs(1),
	RunE: runConnect,
}

func init() {
	connectCmd.Flags().StringVarP(&subdomain, "subdomain", "s", "", "Subdomain of existing tunnel (required)")
	connectCmd.MarkFlagRequired("subdomain")
	
	rootCmd.AddCommand(connectCmd)
}

func runConnect(cmd *cobra.Command, args []string) error {
	port, err := strconv.Atoi(args[0])
	if err != nil {
		return fmt.Errorf("Invalid port number: %s", args[0])
	}

	fmt.Printf("ğŸ”— Connecting to existing tunnel: %s.instatunnel.my\n", subdomain)
	fmt.Printf("ğŸš€ Forwarding to localhost:%d\n", port)
	
	apiKey := getAPIKey()
	if apiKey == "" {
		fmt.Printf("ğŸ’¡ Running in anonymous mode (no API key found)\n")
	}
	
	client, err := tunnel.NewClient(apiKey, getServerURL())
	if err != nil {
		return fmt.Errorf("âŒ Failed to connect: %v", err)
	}
	
	// Connect to existing tunnel
	return client.ConnectToExistingTunnel(subdomain, port)
}
